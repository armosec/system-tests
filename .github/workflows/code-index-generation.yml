name: Generate Code Index

on:
  push:
    branches: [main, master]
    tags:
      - 'v*.*.*'  # Trigger on version tags
    paths-ignore:
      - '**/README.md'
      - '**.md'
  workflow_dispatch:  # Allow manual trigger for testing

  # Allow callers (triggering repo workflows) to generate an index for a specific commit/tag name.
  # This is used to create artifacts like: code-index-rc-vX.Y.Z-NNN (and/or code-index-vX.Y.Z).
  workflow_call:
    inputs:
      TAG_NAME:
        description: 'Artifact tag name to use (e.g., rc-v1.2.3-456 or v1.2.3)'
        type: string
        required: true
      COMMIT_SHA:
        description: 'Commit SHA to checkout and index'
        type: string
        required: true

concurrency:
  group: code-index-${{ github.ref }}
  cancel-in-progress: true

env:
  GH_ACCESS_TOKEN: ${{ secrets.ARMOSEC_GITHUB_ACCESS_TOKEN }}
  GO_VERSION: '1.24'

jobs:
  generate-index:
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: github.com/armosec,github.com/kubescape
    steps:
      - name: Checkout repository (push / tag / manual)
        if: github.event_name != 'workflow_call'
        uses: actions/checkout@v4
        with:
          token: ${{ env.GH_ACCESS_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Checkout repository (workflow_call)
        if: github.event_name == 'workflow_call'
        uses: actions/checkout@v4
        with:
          token: ${{ env.GH_ACCESS_TOKEN }}
          submodules: recursive
          fetch-depth: 0
          ref: ${{ inputs.COMMIT_SHA }}

      - name: Configure Git for private repos
        run: |
          git config --global url.https://${{ env.GH_ACCESS_TOKEN }}@github.com/armosec/.insteadOf https://github.com/armosec/
          git config --global url.https://${{ env.GH_ACCESS_TOKEN }}@github.com/kubescape/.insteadOf https://github.com/kubescape/

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: false
          cache: false

      - name: Install code indexing tools
        run: |
          if [ ! -f "./shared-rules/scripts/code-indexing/install-code-indexing.sh" ]; then
            echo "Error: install-code-indexing.sh not found in shared-rules submodule"
            echo "Make sure the submodule is initialized and points to the correct branch"
            exit 1
          fi
          
          bash ./shared-rules/scripts/code-indexing/install-code-indexing.sh --shared-rules-path shared-rules
          
          # In CI we typically skip symlinks and use direct paths to shared-rules.
          # Accept either layout:
          #  - direct:   ./shared-rules/scripts/code-indexing/indexgen/main.go
          #  - symlink:  ./scripts/code-indexing/indexgen/main.go
          if [ ! -f "./shared-rules/scripts/code-indexing/indexgen/main.go" ] && [ ! -f "./scripts/code-indexing/indexgen/main.go" ]; then
            echo "Error: Code indexing tools not found after installation"
            echo "Expected either ./shared-rules/scripts/code-indexing/indexgen/main.go (direct) or ./scripts/code-indexing/indexgen/main.go (symlinked)"
            exit 1
          fi
          echo "‚úÖ Code indexing tools installed successfully"

      - name: Generate Code Index
        env:
          TEST_RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}
          CI_JOB_ID: ${{ github.job }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          echo "Generating code index..."
          echo "Repository: ${{ github.repository }}"
          echo "Commit: $GITHUB_SHA"
          echo "Branch/Tag: $GITHUB_REF"
          echo "Run ID: $TEST_RUN_ID"
          
          mkdir -p docs/indexes/versions
          
          # Language detection (minimal, fast):
          # - Go repos: go.mod exists ‚Üí use Go indexgen
          # - Python repos: requirements.txt/pyproject.toml/setup.py exists ‚Üí use pyindexgen
          if [ -f "go.mod" ]; then
            echo "Detected Go repository (go.mod present) ‚Üí using Go indexgen (via shared-rules module)"
            # shared-rules is a nested module; run Go tools from within it.
            (cd shared-rules && go run ./scripts/code-indexing/indexgen \
              ../docs/indexes/code-index.json \
              .. \
              --versioned)
          elif [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "Detected Python repository ‚Üí using pyindexgen"
            python3 ./shared-rules/scripts/code-indexing/pyindexgen/pyindexgen.py \
              docs/indexes/code-index.json \
              . \
              --versioned
          else
            echo "Error: Could not detect repository language for code indexing."
            echo "Expected either go.mod (Go) or one of: pyproject.toml / requirements.txt / setup.py (Python)."
            exit 1
          fi
          
          if [ ! -f "docs/indexes/code-index.json" ]; then
            echo "Error: Index file was not generated"
            exit 1
          fi
          
          echo "‚úÖ Index generated successfully"
          echo "Index file size: $(du -h docs/indexes/code-index.json | cut -f1)"
          if [ -f "docs/indexes/versions/code-index-*.json" ]; then
            echo "Versioned index also created"
          fi

      - name: Generate .cursorignore from Code Index
        run: |
          echo "üîç Generating .cursorignore from code index..."

          # shared-rules is a nested Go module; run Go tools from within it.
          (cd shared-rules && go run ./scripts/code-indexing/gen-cursorignore \
            -index ../docs/indexes/code-index.json \
            -output ../.cursorignore \
            -root ..)
          
          if [ ! -f ".cursorignore" ]; then
            echo "Error: .cursorignore was not generated"
            exit 1
          fi
          
          echo "‚úÖ .cursorignore generated successfully"
          echo "File size: $(du -h .cursorignore | cut -f1)"

      - name: Validate Generated Files
        run: |
          echo "üîç Validating generated files..."
          
          # Validate code index structure
          bash ./shared-rules/scripts/code-indexing/validate-index.sh docs/indexes/code-index.json
          
          # Validate .cursorignore exists and has content
          if [ ! -s ".cursorignore" ]; then
            echo "Error: .cursorignore is empty"
            exit 1
          fi
          
          echo "‚úÖ Validation passed"

      - name: Commit code index and .cursorignore
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet docs/indexes/code-index.json .cursorignore 2>/dev/null; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add docs/indexes/code-index.json .cursorignore
          git commit -m "chore: update code index [skip ci]" || echo "Nothing to commit"
          git push || echo "::warning::Failed to push code index commit"

      - name: Upload Index by Commit Hash
        uses: actions/upload-artifact@v4
        with:
          name: code-index-${{ github.sha }}
          path: |
            docs/indexes/code-index.json
            docs/indexes/versions/*.json
          retention-days: 90
          if-no-files-found: warn  # Versioned indexes are optional

      - name: Upload Latest Index
        uses: actions/upload-artifact@v4
        with:
          name: code-index-latest
          path: docs/indexes/code-index.json
          retention-days: 90
          if-no-files-found: error

      - name: Upload Index by Version Tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: code-index-${{ github.ref_name }}
          path: docs/indexes/code-index.json
          retention-days: 90
          if-no-files-found: error

      - name: Upload Index by Tag Name (workflow_call)
        if: github.event_name == 'workflow_call'
        uses: actions/upload-artifact@v4
        with:
          name: code-index-${{ inputs.TAG_NAME }}
          path: docs/indexes/code-index.json
          retention-days: 90
          if-no-files-found: error

      - name: Print artifact summary
        run: |
          echo ""
          echo "üì¶ Code Index Artifacts Created:"
          echo "================================="
          echo "Repository: ${{ github.repository }}"
          echo ""
          echo "1. code-index-${{ github.sha }}"
          echo "   Purpose: Find by commit hash"
          echo "   Retention: 90 days"
          echo ""
          echo "2. code-index-latest"
          echo "   Purpose: Quick access to most recent"
          echo "   Retention: 90 days"
          echo ""
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "3. code-index-${{ github.ref_name }}"
            echo "   Purpose: Find by version tag (RELEASE)"
            echo "   Retention: 90 days"
            echo "   ‚≠ê This is a release build!"
          fi
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "3. code-index-${{ inputs.TAG_NAME }}"
            echo "   Purpose: Find by provided tag name (workflow_call)"
            echo "   Retention: 90 days"
          fi
          echo ""
          echo "‚úÖ .cursorignore generated"
          echo "================================="

