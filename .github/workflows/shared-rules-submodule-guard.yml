name: shared-rules-submodule-guard

on:
  pull_request:

permissions:
  contents: write

jobs:
  verify-submodule:
    name: Verify shared rules submodule
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.repository != 'armosec/armo-ng-app' || github.base_ref != 'master'

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          submodules: 'true'
          token: ${{ secrets.ARMOSEC_GITHUB_ACCESS_TOKEN || secrets.SHARED_RULES_PAT || secrets.GH_SUBMODULE_TOKEN || github.token }}

      - name: Locate shared rules submodule path
        id: locate
        shell: bash
        run: |
          set -euo pipefail

          entry=$(git config -f .gitmodules --get-regexp '^submodule\..*\.url$' | awk '/armosec-ai-shared-rules/ {sub(/^submodule\./,"",$1); sub(/\.url$/,"",$1); print $1; exit}')
          if [[ -z "$entry" ]]; then
            echo "::error::Could not find an armosec-ai-shared-rules submodule entry in .gitmodules"
            exit 1
          fi

          submodule_path=$(git config -f .gitmodules "submodule.${entry}.path")
          if [[ -z "$submodule_path" ]]; then
            echo "::error::Failed to resolve the path for submodule ${entry}"
            exit 1
          fi

          echo "path=$submodule_path" >> "$GITHUB_OUTPUT"

      - name: Run shared rules verification
        shell: bash
        env:
          AUTO_UPDATE: "true"
          MAX_COMMITS_BEHIND: "5"
        run: |
          set -euo pipefail

          submodule_path="${{ steps.locate.outputs.path }}"

          if [[ -z "$submodule_path" ]]; then
            echo "::error::Shared rules submodule path was not detected."
            exit 1
          fi

          if [[ ! -x "$submodule_path/scripts/verify-shared-rules-submodule.sh" ]]; then
            echo "::error::Expected verification script at ${submodule_path}/scripts/verify-shared-rules-submodule.sh."
            echo "Make sure the shared rules submodule is updated to the latest version."
            exit 1
          fi

          # Run verification (may auto-update if within tolerance)
          bash "$submodule_path/scripts/verify-shared-rules-submodule.sh"

          # Check if submodule was updated and commit if needed
          if ! git diff --quiet -- "$submodule_path"; then
            echo "::notice::Submodule was auto-updated. Committing changes..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$submodule_path"
            
            # Try to commit
            if git commit -m "chore: auto-update shared-rules submodule to latest"; then
              # Use GitHub event to get the PR head branch name (more reliable than git rev-parse)
              pr_head_ref="${{ github.event.pull_request.head.ref }}"
              
              if [[ -n "$pr_head_ref" ]]; then
                # Push using explicit HEAD:branch format (more reliable than relying on branch tracking)
                if git push origin HEAD:"$pr_head_ref"; then
                  echo "::notice::Submodule update committed and pushed to PR branch ($pr_head_ref)."
                else
                  echo "::warning::Failed to push submodule update to $pr_head_ref. Please pull and commit manually."
                fi
              else
                # Fallback: try to get branch name from git
                current_branch=$(git rev-parse --abbrev-ref HEAD)
                if [[ -n "$current_branch" && "$current_branch" != "HEAD" ]]; then
                  if git push origin HEAD:"$current_branch"; then
                    echo "::notice::Submodule update committed and pushed to PR branch ($current_branch)."
                  else
                    echo "::warning::Failed to push submodule update to $current_branch. Please pull and commit manually."
                  fi
                else
                  echo "::warning::Could not determine branch name. Please commit manually:"
                  echo "  git add $submodule_path"
                  echo "  git commit -m 'chore: auto-update shared-rules submodule to latest'"
                fi
              fi
            else
              echo "::warning::Failed to commit submodule update. This may be because the commit already exists or there are no changes."
            fi
          fi

