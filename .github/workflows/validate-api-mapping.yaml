name: Validate API Mapping

on:
  pull_request:
    branches:
      - main
      - master
      - dev
      - development
    paths:
      - 'tests_scripts/**'
      - 'infrastructure/backend_api.py'
      - 'system_test_mapping.json'

jobs:
  validate-api-mapping:
    name: Validate Test API Mappings
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for comparison
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
      
      - name: Run API mapping validation
        id: validate
        run: |
          # Make validation script executable
          chmod +x scripts/validate_api_mapping.py
          
          # Run validation
          echo "::group::API Mapping Validation"
          if python3 scripts/validate_api_mapping.py origin/${{ github.base_ref }} HEAD; then
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Validation passed"
          else
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Validation failed"
            exit 1
          fi
          echo "::endgroup::"
      
      - name: Comment on PR (if failed)
        if: failure() && steps.validate.outputs.validation_passed == 'false'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const comment = `## ‚ùå API Mapping Validation Failed
            
            The tests you modified have API calls that don't match the mappings in \`system_test_mapping.json\`.
            
            ### How to fix:
            
            1. **Regenerate the API mappings:**
               \`\`\`bash
               python3 scripts/update_mapping_with_methods.py
               \`\`\`
            
            2. **Review the changes:**
               \`\`\`bash
               git diff system_test_mapping.json
               \`\`\`
            
            3. **Commit the updated mapping:**
               \`\`\`bash
               git add system_test_mapping.json
               git commit -m "Update API mappings for modified tests"
               git push
               \`\`\`
            
            ### Why is this important?
            
            The \`system_test_mapping.json\` file tracks which backend APIs each test validates. This helps with:
            - üìä Test coverage visibility
            - üîç Impact analysis when APIs change
            - üß™ Running relevant tests for API changes
            - üìù Documentation of test scope
            
            Please update the mapping and push your changes.`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: comment
            });
      
      - name: Success message
        if: success()
        run: |
          echo "‚úÖ API mapping validation passed!"
          echo "All test API mappings are accurate and up to date."
